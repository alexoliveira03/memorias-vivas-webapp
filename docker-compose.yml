version: '3.8'

services:
  webapp:
    build:
      context: .
      dockerfile: Dockerfile
    image: memorias-vivas:latest
    ports:
      - "3001:3000"
    env_file:
      - .env.production
    restart: unless-stopped
    networks:
      - memorias-vivas-net
      - traefik-public  # Connect to Traefik network
    deploy:
      mode: replicated
      replicas: 2  # 2 replicas para alta disponibilidade
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      resources:
        limits:
          cpus: '0.75'     # 75% CPU por réplica
          memory: 768M     # 768MB RAM por réplica
        reservations:
          cpus: '0.25'     # Mínimo 25% CPU
          memory: 256M     # Mínimo 256MB RAM
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.memorias-vivas.rule=Host(`living-memories.net`) || Host(`www.living-memories.net`)"
        - "traefik.http.routers.memorias-vivas.entrypoints=web,websecure"
        - "traefik.http.services.memorias-vivas.loadbalancer.server.port=3000"
        - "traefik.http.routers.memorias-vivas.service=memorias-vivas"
        # Redirect www to non-www
        - "traefik.http.middlewares.memorias-vivas-redirect.redirectregex.regex=^https://www\\.(.+)"
        - "traefik.http.middlewares.memorias-vivas-redirect.redirectregex.replacement=https://$${1}"
        - "traefik.http.routers.memorias-vivas.middlewares=memorias-vivas-redirect"

networks:
  memorias-vivas-net:
    driver: overlay
    attachable: true
  traefik-public:
    external: true  # Use existing Traefik network
